<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Intervenții Urs Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    #map { height: 100vh; }
    
    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    
    .legend h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
    }
    
    .legend-item input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid #333;
    }
    
    .color-blue { background-color: blue; }
    .color-green { background-color: green; }
    .color-red { background-color: red; }
    .color-darkred { background-color: darkred; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="legend">
  <h4>Tipuri Intervenție</h4>
  <div class="legend-item">
    <input type="checkbox" id="filter-alungare" checked onchange="toggleCategory('Alungare')">
    <div class="legend-color color-blue"></div>
    <span onclick="toggleCheckbox('filter-alungare')">Alungare</span>
  </div>
  <div class="legend-item">
    <input type="checkbox" id="filter-relocare" checked onchange="toggleCategory('Relocare')">
    <div class="legend-color color-green"></div>
    <span onclick="toggleCheckbox('filter-relocare')">Relocare</span>
  </div>
  <div class="legend-item">
    <input type="checkbox" id="filter-eutanasiere" checked onchange="toggleCategory('Eutanasiere')">
    <div class="legend-color color-red"></div>
    <span onclick="toggleCheckbox('filter-eutanasiere')">Eutanasiere</span>
  </div>
  <div class="legend-item">
    <input type="checkbox" id="filter-impuscare" checked onchange="toggleCategory('Împușcare')">
    <div class="legend-color color-darkred"></div>
    <span onclick="toggleCheckbox('filter-impuscare')">Împușcare</span>
  </div>
  <a href="https://interventiiurs.mmap.ro/centralizator/">sursă date</a> / <a href="stats.html">stats</a>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- PapaParse for CSV parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
  // Initialize the map
  const map = L.map('map').setView([45.9432, 24.9668], 7); // Centered on Romania

  // Add OpenStreetMap tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Store markers by category
  const markerCategories = {
    'Alungare': [],
    'Relocare': [],
    'Eutanasiere': [],
    'Împușcare': []
  };

  // Toggle checkbox when clicking on text
  function toggleCheckbox(checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
  }

  // Toggle category visibility
  function toggleCategory(category) {
    const idMap = {
      'Alungare': 'filter-alungare',
      'Relocare': 'filter-relocare', 
      'Eutanasiere': 'filter-eutanasiere',
      'Împușcare': 'filter-impuscare'
    };
    
    const checkbox = document.getElementById(idMap[category]);
    const isVisible = checkbox.checked;
    
    markerCategories[category].forEach(marker => {
      if (isVisible) {
        map.addLayer(marker);
      } else {
        map.removeLayer(marker);
      }
    });
  }

  // Load and parse CSV
  fetch('data/Interventii Urs.csv')
    .then(response => response.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log('Parsed data:', results.data);
          
          results.data.forEach(row => {
            // Try different coordinate columns based on intervention type
            let lat, lng, interventionType, date;
            
            // Check for intervention coordinates (alungare)
            if (row['Coordonate interventie alungare Y (WGS84, grade zecimale)'] && 
                row['Coordonate interventie alungare X (WGS84, grade zecimale)']) {
              lat = parseFloat(row['Coordonate interventie alungare Y (WGS84, grade zecimale)']);
              lng = parseFloat(row['Coordonate interventie alungare X (WGS84, grade zecimale)']);
              interventionType = 'Alungare';
              date = row['Data interventie alungare'];
            }
            // Check for relocation coordinates
            else if (row['Coordonate relocare Y (WGS84, grade zecimale)'] && 
                     row['Coordonate relocare X (WGS84, grade zecimale)']) {
              lat = parseFloat(row['Coordonate relocare Y (WGS84, grade zecimale)']);
              lng = parseFloat(row['Coordonate relocare X (WGS84, grade zecimale)']);
              interventionType = 'Relocare';
              date = row['Data relocare'];
            }
            // Check for euthanasia coordinates
            else if (row['Coordonate eutanasiere Y (WGS84, grade zecimale)'] && 
                     row['Coordonate eutanasiere X (WGS84, grade zecimale)']) {
              lat = parseFloat(row['Coordonate eutanasiere Y (WGS84, grade zecimale)']);
              lng = parseFloat(row['Coordonate eutanasiere X (WGS84, grade zecimale)']);
              interventionType = 'Eutanasiere';
              date = row['Data interventie eutanasiere'];
            }
            // Check for shooting coordinates
            else if (row['Coordonate impuscare Y (WGS84, grade zecimale)'] && 
                     row['Coordonate impuscare X (WGS84, grade zecimale)']) {
              lat = parseFloat(row['Coordonate impuscare Y (WGS84, grade zecimale)']);
              lng = parseFloat(row['Coordonate impuscare X (WGS84, grade zecimale)']);
              interventionType = 'Împușcare';
              date = row['Data interventie impuscare'];
            }
            
            if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
              const popupContent = `
                <strong>${row['Judet'] || 'Fără județ'}</strong><br/>
                UAT: ${row['UAT'] || 'N/A'}<br/>
                Tip intervenție: ${interventionType}<br/>
                Data: ${date || 'N/A'}<br/>
                Sex: ${row['Sex'] || 'N/A'}<br/>
                Detalii: ${row['Detalii referitoare la eveniment'] || 'N/A'}
              `;
              
              // Different colors for different intervention types
              let color = 'blue';
              if (interventionType === 'Relocare') color = 'green';
              else if (interventionType === 'Eutanasiere') color = 'red';
              else if (interventionType === 'Împușcare') color = 'darkred';
              
              const marker = L.circleMarker([lat, lng], {
                color: color,
                fillColor: color,
                fillOpacity: 0.7,
                radius: 6
              }).bindPopup(popupContent);
              
              // Add to map and store in category
              marker.addTo(map);
              markerCategories[interventionType].push(marker);
            }
          });
        }
      });
    })
    .catch(error => {
      console.error('Error loading CSV:', error);
    });
</script>

</body>
</html>
